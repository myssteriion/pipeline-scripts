void runBuild(String gitRoot, String projectRoot, String jdk, String mvn, String targetDirectory, String sourceAppDirectory, String sourceConfDirectory) {
	
	sh "mkdir -p ${gitRoot}"

	dir ("${gitRoot}") {
		checkoutRevisionOnRepo(gitRoot)
		mvnCleanInstall(projectRoot, jdk, mvn)
		deploy(projectRoot, targetDirectory, sourceAppDirectory, sourceConfDirectory)
	}
}

void checkoutRevisionOnRepo(String gitRoot) {
	checkout scm: [ $class: "GitSCM", 
					userRemoteConfigs: [ [url: env.gitLabUrl+gitRoot, credentialsId: "root"] ],
					branches: [ [name: params.revision] ]
				  ], poll: false
}

void mvnCleanInstall(String projectRoot, String jdk, String mvn) {
	dir ("${projectRoot}") {
		withMaven (jdk: jdk, maven: mvn) {
			sh "mvn clean install"
		}
	}
}

void deploy(String projectRoot, String targetDirectory, String sourceAppDirectory, String sourceConfDirectory) {

	script {
		
		if (targetDirectory && targetDirectory != "") {
			sh "ssh ${env.primaryRemote} rm -rf ${env.depotFolder}/${params.revision}/$esiiFolder/$appFolder/${targetDirectory}"
			sh "ssh ${env.primaryRemote} rm -rf ${env.depotFolder}/${params.revision}/$esiiFolder/$confFolder/${targetDirectory}"
		
			if (sourceAppDirectory && sourceAppDirectory != "") {
				sh "ssh ${env.primaryRemote} mkdir -p ${env.depotFolder}/${params.revision}/$esiiFolder/$appFolder/${targetDirectory}"
				sh "scp ${projectRoot}/${sourceAppDirectory}/*.war ${env.primaryRemote}:${env.depotFolder}/${params.revision}/$esiiFolder/$appFolder/${targetDirectory}"
				sh "ssh ${env.primaryRemote} unzip ${env.depotFolder}/${params.revision}/$esiiFolder/$appFolder/${targetDirectory}/*.war -d ${env.depotFolder}/${params.revision}/$esiiFolder/$appFolder/${targetDirectory}/"
				sh "ssh ${env.primaryRemote} rm -f ${env.depotFolder}/${params.revision}/$esiiFolder/$appFolder/${targetDirectory}/*.war"
			}
			if (sourceConfDirectory && sourceConfDirectory != "") {
				sh "ssh ${env.primaryRemote} mkdir -p ${env.depotFolder}/${params.revision}/$esiiFolder/$confFolder/${targetDirectory}"
				sh "scp -r ${projectRoot}/${sourceConfDirectory}/* ${env.primaryRemote}:${env.depotFolder}/${params.revision}/$esiiFolder/$confFolder/${targetDirectory}"
			}
		}
	}
}

void deployToSecondaryRemote(String secondaryRemote) {
	sh "ssh ${secondaryRemote} \"rm -rf $esiiFolder && mkdir -p $esiiFolder\""
	
	sh "scp -r ${env.primaryRemote}:${env.depotFolder}/${params.revision}/$esiiFolder.gz ${secondaryRemote}:"
	sh "ssh ${secondaryRemote} tar -xf $esiiFolder.gz"
	
	sh "ssh ${secondaryRemote} rm -rf $esiiFolder.gz"
}